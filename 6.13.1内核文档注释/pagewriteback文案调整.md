## 功能背景
保留压缩簇的那段文案。
## 重大问题分析
保留原来的跨簇了 重试了 解锁了等重大问题以外啊,
我们新加一些决赛期间发现的重大问题。注意我提到的这些改动都只做增量的修改。
1.因为page writeback需要处理多种情况。除了直接由fsync调用将所有脏页写回以外,
还有内核的pflush线程在后台会进行定时的脏页写回。后者触发的时候 会遍历相当数量的已经被写回过的清除脏标记的folio。
此时它们并不会正常走
find dirty range和提交io的逻辑 因此 我们必须手动将这些folio 不论它们的阶数是0还是不是0 都将它们给解锁 并且由于它们根本不会被提交到bio 也自然不会被通过bio的回调调用folio_end_writeback
因此对于这种情况的话我们必须手动在最后将它们给end_writeback。
2.另一大问题是f2fs_do_write_data_page中,这里要强调出是原先内核上游补丁考虑欠妥的地方,它直接将folio->index也就是头页作为块查询的索引了,而我们此时期望的是一个可能是某个子页的索引
因此我们改为传递了folio_index+folio_page_idx(folio,fio->page)
3.下一个重大问题是 f2fs_submit_page_bio也是因为内核的改动 导致其将folio给添加到bio的时候,我们想添加的是某个子page,但是这行代码错误地直接将整个folio_size给添加进去了,导致bio中记录的信息
是错误的。所以我们的改动 还是加上了具体我们要将folio的哪个子部分给添加到bio之中。
具体的解决方案代码我们在后面的部分给出吧。
